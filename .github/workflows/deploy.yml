name: Deploy load_metrics

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Servers
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: root
          key: ${{ secrets.DEPLOYMENT_KEY }}
          port: 22
          timeout: 30s
          command_timeout: 10m
          script: |
            cd /root/load_metrics
            
            # Switch to SSH URL
            git remote set-url origin git@github.com:pjmilkymommyveeve/load_metrics.git
            
            # Pull latest changes
            GIT_SSH_COMMAND="ssh -i /root/.ssh/remoterepo -o StrictHostKeyChecking=no" git pull origin master
            
            # Create logs directory if it doesn't exist
            mkdir -p /root/load_metrics/logs
            
            # Stop the running process
            pm2 stop metrics-server || true
            
            # Build the Go application
            go build -o metrics_server
            
            # Make executable
            chmod +x metrics_server
            
            # Start/reload with PM2
            pm2 startOrReload ecosystem.config.js
            pm2 save